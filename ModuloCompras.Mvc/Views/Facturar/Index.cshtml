@{
    ViewBag.Title = "Facturar";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var proveedores = ViewBag.Proveedores as List<ModuloCompras.Entidades.Proveedor>;
    var productos = ViewBag.Productos as List<ModuloCompras.Mvc.Models.Producto>;
}

<h1 class="text-center my-4">Facturar</h1>

<div class="row justify-content-center">
    <div class="col-md-6">
        <form>
            <div class="mb-3">
                <label>Proveedor:</label>
                <select id="proveedor" name="proveedor" class="form-control">
                    <option value="">Seleccione un proveedor</option>
                    @if (proveedores != null)
                    {
                        foreach (var proveedor in proveedores)
                        {
                            <option value="@proveedor.Id" data-tipopago="@proveedor.TipoProveedor">@proveedor.Apellidos @proveedor.Nombres</option>
                        }
                    }
                </select>
                <br />
                <label>Fecha:</label>
                <input type="text" id="fecha" name="fecha" value="@DateTime.Now.ToString("yyyy-MM-dd")" class="form-control" readonly />
                <br />
                <label>Fecha de Vencimiento:</label>
                <input type="date" id="fechaVencimiento" name="fechaVencimiento" class="form-control" />
                <br />
                <label>Tipo de Pago:</label>
                <input type="text" id="tipoPago" name="tipoPago" class="form-control" readonly />
                <br />
            </div>

            <div class="mb-3">
                <h3 class="mt-4">Detalle de Productos</h3>
                <label>Seleccionar Producto:</label>
                <select id="codigoProducto" name="codigoProducto" class="form-control" onchange="cargarProductoSeleccionado()">
                    <option value="">Seleccione un producto</option>
                    @if (productos != null)
                    {
                        foreach (var producto in productos)
                        {
                            <option value="@producto.Codigo"
                                    data-descripcion="@producto.Descripcion"
                                    data-precio="@producto.Pvp"
                                    data-stock="@producto.StockProducto"
                                    data-gravaiva="@producto.GravaIVA">
                                @producto.Codigo - @producto.Descripcion
                            </option>
                        }
                    }
                </select>

                <br />
                <label>Descripción:</label>
                <input type="text" id="descripcion" name="descripcion" class="form-control" readonly />
                <br />
                <label>Precio Unitario:</label>
                <input type="text" id="precioUnitario" name="precioUnitario" class="form-control" readonly />
                <br />
                <label>Stock:</label>
                <input type="text" id="stock" name="stock" class="form-control" readonly />
                <br />
                <label>Cantidad:</label>
                <input type="number" id="cantidad" name="cantidad" class="form-control" />
                <br />
                <label>Grava IVA:</label>
                <input type="checkbox" id="gravaIVA" name="gravaIVA" class="form-check-input" readonly />
                <br />
                <button type="button" class="btn btn-primary" onclick="agregarProducto()">Agregar</button>
            </div>

            <table id="detalleFactura" class="table table-striped table-bordered mt-4">
                <thead class="thead-dark">
                    <tr>
                        <th>Código</th>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio Unitario</th>
                        <th>Grava IVA</th>
                        <th>Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <div class="mt-4">
                <label>Subtotal:</label>
                <span id="subtotal"></span>
                <br />
                <label>IVA:</label>
                <span id="iva"></span>
                <br />
                <label>Total:</label>
                <span id="total"></span>
                <br />
                <div class="form-group text-center mt-4 d-flex justify-content-center">
                    <button type="button" class="btn btn-secondary mx-2" onclick="cancelar()"><i class="fas fa-times"></i> Cancelar</button>
                    <button type="button" class="btn btn-primary mx-2" onclick="guardar()"><i class="fas fa-save"></i> Guardar</button>
                    <button type="button" class="btn btn-success mx-2" onclick="imprimir()"><i class="fas fa-print"></i> Imprimir</button>
                </div>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <script>
        function cargarProductoSeleccionado() {
            var select = document.getElementById("codigoProducto");
            var selectedOption = select.options[select.selectedIndex];

            document.getElementById("descripcion").value = selectedOption.getAttribute("data-descripcion");
            document.getElementById("precioUnitario").value = selectedOption.getAttribute("data-precio");
            document.getElementById("stock").value = selectedOption.getAttribute("data-stock");

            var gravaIVA = selectedOption.getAttribute("data-gravaiva");
            document.getElementById("gravaIVA").checked = (gravaIVA === 'true' || gravaIVA === 'True');
        }

        function agregarProducto() {
            var codigo = document.getElementById("codigoProducto").value;
            var descripcion = document.getElementById("descripcion").value;
            var cantidad = parseFloat(document.getElementById("cantidad").value);
            var precioUnitario = parseFloat(document.getElementById("precioUnitario").value);
            var gravaIVA = document.getElementById("gravaIVA").checked;
            var subtotal = cantidad * precioUnitario;
            var iva = gravaIVA ? subtotal * 0.15 : 0;
            var total = subtotal + iva;

            var table = document.getElementById("detalleFactura").getElementsByTagName("tbody")[0];
            var newRow = table.insertRow(table.rows.length);

            var cellCodigo = newRow.insertCell(0);
            var cellDescripcion = newRow.insertCell(1);
            var cellCantidad = newRow.insertCell(2);
            var cellPrecioUnitario = newRow.insertCell(3);
            var cellIVA = newRow.insertCell(4);
            var celltotal = newRow.insertCell(5);

            cellCodigo.innerHTML = codigo;
            cellDescripcion.innerHTML = descripcion;
            cellCantidad.innerHTML = cantidad;
            cellPrecioUnitario.innerHTML = precioUnitario.toFixed(2);
            cellIVA.innerHTML = iva.toFixed(2);
            celltotal.innerHTML = total.toFixed(2);

            actualizarTotales();
        }

        function actualizarTotales() {
            var table = document.getElementById("detalleFactura").getElementsByTagName("tbody")[0];
            var subtotal = 0;
            var iva = 0;
            var total = 0;

            for (var i = 0; i < table.rows.length; i++) {
                var row = table.rows[i];
                var cantidad = parseFloat(row.cells[2].innerHTML);
                var precioUnitario = parseFloat(row.cells[3].innerHTML);
                var gravaIVA = row.cells[4].innerHTML === 'Sí';
                var subtotalRow = cantidad * precioUnitario;
                var ivaRow = gravaIVA ? subtotalRow * 0.15 : 0;
                subtotal += subtotalRow;
                iva += ivaRow;
            }

            total = subtotal + iva;

            document.getElementById("subtotal").innerHTML = subtotal.toFixed(2);
            document.getElementById("iva").innerHTML = iva.toFixed(2);
            document.getElementById("total").innerHTML = total.toFixed(2);
        }

        function cancelar() {
            // Implementar lógica de cancelar
        }

        function guardar() {
            // Implementar lógica de guardar
        }

        function imprimir() {
            // Implementar lógica de imprimir
        }

        $(document).ready(function () {
            $('#proveedor').change(function () {
                var selectedOption = $(this).find('option:selected');
                var tipoPago = selectedOption.data('tipopago');
                $('#tipoPago').val(tipoPago);
            });

            var today = new Date().toISOString().split('T')[0];
            document.getElementById("fechaVencimiento").setAttribute('min', today);
        });
    </script>
}
